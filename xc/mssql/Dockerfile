# escape=`
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

ARG SQL_DB_PREFIX
ARG COMMERCE_DB_PREFIX
ARG COMMERCE_ENGINE_PACKAGE
ARG COMMERCE_CONNECT_ENGINE_PACKAGE
ARG COMMERCE_CONNECT_PACKAGE
ARG COMMERCE_MA_PACKAGE
ARG COMMERCE_XPROFILES_PACKAGE
ARG COMMERCE_XANALYTICS_PACKAGE

ENV COMMERCE_DB_PREFIX=${COMMERCE_DB_PREFIX}

COPY files/$COMMERCE_ENGINE_PACKAGE ${INSTALL_PATH}/
COPY files/$COMMERCE_CONNECT_PACKAGE ${INSTALL_PATH}/
COPY files/$COMMERCE_CONNECT_ENGINE_PACKAGE ${INSTALL_PATH}/
COPY files/$COMMERCE_MA_PACKAGE ${INSTALL_PATH}/
COPY files/$COMMERCE_XPROFILES_PACKAGE ${INSTALL_PATH}/
COPY files/$COMMERCE_XANALYTICS_PACKAGE ${INSTALL_PATH}/
COPY xc/mssql/*.ps1 ${INSTALL_PATH}

RUN & (Join-Path $env:INSTALL_PATH "Extract-Databases.ps1") -Path $env:INSTALL_PATH; `
    & (Join-Path $env:INSTALL_PATH "Install-Databases.ps1") -InstallPath $env:INSTALL_PATH -DataPath $env:DATA_PATH -DatabasePrefix $Env:SQL_DB_PREFIX -CommerceDatabasePrefix $Env:COMMERCE_DB_PREFIX; `
    Get-ChildItem -Path $env:INSTALL_PATH -Exclude "*.mdf", "*.ldf" | Remove-Item -Force -Recurse;
