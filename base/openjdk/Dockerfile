# escape=`
# Based on https://github.com/sitecoreops/sitecore-images/blob/master/images/sitecore-openjdk/nanoserver-1809/Dockerfile
FROM mcr.microsoft.com/windows/servercore:1903 as builder

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Install JAVA
ENV JAVA_HOME C:\\ojdkbuild
ENV JAVA_VERSION 8u191
ENV JAVA_OJDKBUILD_VERSION 1.8.0.191-1
ENV JAVA_OJDKBUILD_ZIP java-1.8.0-openjdk-1.8.0.191-1.b12.ojdkbuild.windows.x86_64.zip

RUN [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; `
    Invoke-WebRequest -Uri $('https://github.com/ojdkbuild/ojdkbuild/releases/download/{0}/{1}' -f $env:JAVA_OJDKBUILD_VERSION, $env:JAVA_OJDKBUILD_ZIP) -UseBasicParsing -OutFile 'ojdkbuild.zip'; `
    Expand-Archive ojdkbuild.zip -DestinationPath C:\; `
    Move-Item -Path ('C:\\{0}' -f ($env:JAVA_OJDKBUILD_ZIP -Replace '.zip', '')) -Destination $env:JAVA_HOME;

# Runtime image
FROM mcr.microsoft.com/windows/nanoserver:1903 as final

# Run under admin user as by default nanoserver starts with ContainerUser iso ContainerAdministrator
# See https://techcommunity.microsoft.com/t5/Windows-Server-Insiders/nanoserver-insider-image-has-non-admin-user-as-default/td-p/110290
USER ContainerAdministrator

COPY --from=builder /ojdkbuild /ojdkbuild

ENV JAVA_HOME C:\\ojdkbuild
